<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>לוח עברי עם אירועים</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- Hebcal לצורך תאריך עברי -->
  <script src="https://unpkg.com/hebcal@2.5.0/dist/hebcal.browser.js"></script>

  <style>
    body {
      direction: rtl;
      font-family: sans-serif;
      padding: 2rem;
    }
    #calendar {
      max-width: 900px;
      margin: 0 auto;
    }
    .fc-event-title {
      white-space: pre-line;
    }
  </style>
</head>
<body>

  <h2>לוח אירועים עם תאריך עברי</h2>
  <div id="calendar"></div>

  <script>
    const BASE_ID = 'appOiQPHQxRKhPJZs';
    const TABLE_NAME = 'ארועים';
    const AIRTABLE_TOKEN = 'patNdl6nMVJj0BAaI.ca2870912b8d2fcd34c3a35fbc793edc7255cf7bb47b3e65e8db8fbcf1596e74';

    document.addEventListener('DOMContentLoaded', async function () {
      const calendarEl = document.getElementById('calendar');

      const airtableUrl = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_NAME)}`;
      const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(airtableUrl);

      let events = [];

      try {
        const res = await fetch(proxyUrl, {
          headers: {
            'Authorization': 'Bearer ' + AIRTABLE_TOKEN,
            'Content-Type': 'application/json'
          }
        });

        const data = await res.json();

        events = data.records.map(record => {
          const title = record.fields.Name || 'ללא כותרת';
          const startDate = record.fields.Date;
          const description = record.fields['תאור'] || '';

          // תאריך עברי
          const gdate = new Date(startDate);
          const hdate = new Hebcal.HDate(gdate);
          const hebrewDateStr = hdate.renderGematriya();

          return {
            title: `${title}\n(${hebrewDateStr})`,
            start: startDate,
            description: description
          };
        });

      } catch (err) {
        console.error('שגיאה בטעינת נתונים מ-Airtable:', err);
      }

      const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'he',
        initialView: 'dayGridMonth',
        direction: 'rtl',
        events: events,
        eventDidMount: function (info) {
          if (info.event.extendedProps.description) {
            info.el.title = info.event.extendedProps.description;
          }
        },
        headerToolbar: {
          start: 'title',
          center: '',
          end: 'prev,next today'
        }
      });

      calendar.render();
    });
  </script>

</body>
</html>
