<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>לוח שנה עברי</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet">
  <style>
    body { font-family: sans-serif; padding: 20px; direction: rtl; }
    #calendar { max-width: 1000px; margin: auto; }
    form { margin: 20px auto; max-width: 600px; background: #f0f0f0; padding: 15px; border-radius: 8px; }
    input, textarea { width: 100%; margin: 5px 0; padding: 8px; }
    button { padding: 8px 16px; }
  </style>
</head>
<body>

<h2>לוח אירועים עברי</h2>

<div id="calendar"></div>

<h3>הוסף אירוע חדש</h3>
<form id="eventForm">
  <input type="text" id="name" placeholder="שם האירוע" required>
  <input type="date" id="date" required>
  <textarea id="teur" placeholder="תיאור (אופציונלי)"></textarea>
  <button type="submit">שמור</button>
</form>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script>
  const AIRTABLE_API_KEY = 'patNdl6nMVJj0BAaI.ca2870912b8d2fcd34c3a35fbc793edc7255cf7bb47b3e65e8db8fbcf1596e74';
  const BASE_ID = 'appOiQPHQxRKhPJZs';
  const TABLE_NAME = 'ארועים'; // שים לב אם הטבלה שלך נקראת בדיוק כך (עברית)

  document.addEventListener('DOMContentLoaded', async function () {
    const calendarEl = document.getElementById('calendar');

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'he',
      events: async function (fetchInfo, successCallback) {
        const res = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_NAME)}?api_key=${AIRTABLE_API_KEY}`);
        const data = await res.json();
        const events = await Promise.all(data.records.map(async record => {
          const date = record.fields.Date;
          let hebrewDate = '';
          try {
            const [y, m, d] = date.split("-");
            const hres = await fetch(`https://www.hebcal.com/converter?cfg=json&gy=${y}&gm=${m}&gd=${d}&g2h=1`);
            const hdata = await hres.json();
            hebrewDate = hdata.hebrew;
          } catch (e) { console.warn("Hebrew date fetch failed"); }

          return {
            title: record.fields.Name,
            start: date,
            extendedProps: {
              hebrew: hebrewDate,
              description: record.fields["תאור"] || ''
            }
          };
        }));
        successCallback(events);
      },
      eventDidMount: function (info) {
        if (info.event.extendedProps.hebrew) {
          const heb = document.createElement('div');
          heb.textContent = info.event.extendedProps.hebrew;
          heb.style.fontSize = '0.75em';
          heb.style.color = '#666';
          info.el.appendChild(heb);
        }
      }
    });

    calendar.render();

    // טופס הוספת אירוע
    document.getElementById('eventForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const date = document.getElementById('date').value;
      const teur = document.getElementById('teur').value;

      const res = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_NAME)}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          fields: { Name: name, Date: date, "תאור": teur }
        })
      });

      if (res.ok) {
        alert("האירוע נשמר!");
        calendar.refetchEvents();
        e.target.reset();
      } else {
        alert("שגיאה בהוספה");
      }
    });
  });
</script>
</body>
</html>
